define("tiny_multilang2/ui",["exports","./options"],(function(_exports,_options){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.onSubmit=_exports.onInit=_exports.onDelete=_exports.onBeforeGetContent=_exports.applyLanguage=void 0;
/**
   * Commands for the plugin logic of the Moodle tiny_multilang2 plugin.
   *
   * @module      tiny_multilang2
   * @author      Iñaki Arenaza <iarenaza@mondragon.edu>
   * @author      Stephan Robotta <stephan.robotta@bfh.ch>
   * @copyright   2015 onwards Iñaki Arenaza & Mondragon Unibertsitatea
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */
const spanClass="multilang-begin mceNonEditable",spanFixedAttrs='<span contenteditable="false" class="'+spanClass+'" data-mce-contenteditable="false"',spanMultilangBegin=spanFixedAttrs+' lang="%lang" xml:lang="%lang">{mlang %lang}</span>',spanMultilangEnd=spanFixedAttrs.replace("begin","end")+">{mlang}</span>",isNull=a=>null==a,addVisualStyling=function(ed){let content=ed.getContent();if(-1!==content.indexOf(spanClass))return content;if(content=content.replace(new RegExp("{\\s*mlang\\s+([^}]+?)\\s*}","ig"),(function(match,p1){return spanMultilangBegin.replace(new RegExp("%lang","g"),p1)})),content=content.replace(new RegExp("{\\s*mlang\\s*}","ig"),spanMultilangEnd),(0,_options.mlangFilterExists)(ed)&&!(0,_options.isFallbackSpanTag)(ed))return content;const doc=(new DOMParser).parseFromString(content,"text/html");if(0===doc.children.length)return content;const nodes=doc.querySelectorAll("span.multilang");if(0===nodes.length)return content;for(const span of nodes){const newSpan=spanMultilangBegin.replace(new RegExp("%lang","g"),span.getAttribute("lang")).replace("mceNonEditable","mceNonEditable fallback")+span.innerHTML+spanMultilangEnd.replace("mceNonEditable","mceNonEditable fallback");span.insertAdjacentHTML("afterend",newSpan),span.remove()}return doc.getElementsByTagName("body")[0].innerHTML},removeVisualStyling=function(ed){["begin","end"].forEach((function(t){for(const span of ed.dom.select("span.multilang-"+t))if("begin"===t&&span.classList.contains("fallback")){let innerHTML="",end=span,toRemove=[];for(;end&&(end=end.nextSibling,!isNull(end));){if(!isNull(end.classList)&&end.classList.contains("multilang-end")){toRemove.push(end);break}3===end.nodeType?innerHTML+=end.nodeValue:1===end.nodeType&&(innerHTML+=end.outerHTML),toRemove.push(end)}if(!isNull(end)){const lang=span.innerHTML.match(new RegExp("{\\s*mlang\\s+([^}]+?)\\s*}","i"));if(lang)for(end of(ed.dom.setOuterHTML(span,'<span class="multilang" lang="'+lang[1]+'">'+innerHTML+"</span>"),toRemove))ed.dom.remove(end)}}else ed.dom.setOuterHTML(span,span.innerHTML.toLowerCase())}))},getHighlightNodeFromSelect=function(ed,search){let span;return ed.dom.getParents(ed.selection.getStart(),(elm=>{if(!isNull(elm.classList)){const pair="begin"===search?"end":"begin";if(elm.classList.contains("multilang-"+pair)){span=elm;do{span="begin"===search?span.previousSibling:span.nextSibling}while(!isNull(span)&&(isNull(span.classList)||!span.classList.contains("multilang-"+search)))}else elm.classList.contains("multilang-"+search)&&(span=elm)}})),span};_exports.onInit=function(ed){(0,_options.isContentToHighlight)(ed)&&(ed.dom.addStyle((0,_options.getHighlightCss)(ed)),ed.setContent(addVisualStyling(ed)))};_exports.onBeforeGetContent=function(ed,content){if(!isNull(content.source_view)&&!0===content.source_view){var onClose=function(ed){ed.off("close",onClose),ed.setContent(addVisualStyling(ed))};ed.on("CloseWindow",(()=>{onClose(ed)})),(0,_options.isContentToHighlight)(ed)&&removeVisualStyling(ed)}};_exports.onSubmit=function(ed){removeVisualStyling(ed)};_exports.onDelete=function(ed,event){if(event.isComposing||46!==event.keyCode&&8!==event.keyCode||!(0,_options.isContentToHighlight)(ed))return;const begin=getHighlightNodeFromSelect(ed,"begin"),end=getHighlightNodeFromSelect(ed,"end");isNull(begin)||isNull(end)||(event.preventDefault(),ed.dom.remove(begin),ed.dom.remove(end))};_exports.applyLanguage=function(ed,iso){if(null===iso)return;const regexLang=/%lang/g;let text=ed.selection.getContent();if(""===text.toString().replace(/^\s+/,"").replace(/\s+$/,"")){let newtext;return(0,_options.isContentToHighlight)(ed)?(newtext=spanMultilangBegin.replace(regexLang,iso)+" "+spanMultilangEnd,(0,_options.mlangFilterExists)(ed)||(newtext=newtext.replaceAll("mceNonEditable","mceNonEditable fallback"))):newtext=(0,_options.mlangFilterExists)(ed)?"{mlang "+iso+"} {mlang}":'<span class="multilang" lang="%lang">'.replace(regexLang,iso)+" </span>",void ed.insertContent(newtext)}if(!(0,_options.isContentToHighlight)(ed))return void((0,_options.mlangFilterExists)(ed)?ed.selection.setContent("{mlang "+iso+"}"+text+"{mlang}"):ed.selection.setContent('<span class="multilang" lang="%lang">'.replace(regexLang,iso)+text+"</span>"));const span=getHighlightNodeFromSelect(ed,"begin");if(!isNull(span)){let replacement=spanMultilangBegin.replace(regexLang,iso);return span.classList.contains("fallback")&&(replacement=replacement.replace("mceNonEditable","mceNonEditable fallback")),void ed.dom.setOuterHTML(span,replacement)}let newtext=spanMultilangBegin.replace(regexLang,iso)+text+spanMultilangEnd;(0,_options.mlangFilterExists)(ed)||(newtext=newtext.replaceAll("mceNonEditable","mceNonEditable fallback")),ed.selection.setContent(newtext)}}));

//# sourceMappingURL=ui.min.js.map