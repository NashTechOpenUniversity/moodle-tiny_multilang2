{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Commands for the plugin logic of the Moodle tiny_multilang2 plugin.\n *\n * @module      tiny_multilang2\n * @author      Iñaki Arenaza <iarenaza@mondragon.edu>\n * @author      Stephan Robotta <stephan.robotta@bfh.ch>\n * @copyright   2015 onwards Iñaki Arenaza & Mondragon Unibertsitatea\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {getHighlightCss, isContentToHighlight, isFallbackSpanTag} from './options';\n\n// This class inside a <span> identified the {mlang} tag that is encapsulated in a span.\nconst spanClass = 'multilang-begin mceNonEditable';\n// This is the <span> element with the data attribute.\nconst spanFixedAttrs = '<span contenteditable=\"false\" class=\"' + spanClass + '\" data-mce-contenteditable=\"false\"';\n// The begin span needs the language attributes inside the span and the mlang attribute.\nconst spanMultilangBegin = spanFixedAttrs + ' lang=\"%lang\" xml:lang=\"%lang\">{mlang %lang}</span>';\n// The end span doesn't need information about the used language.\nconst spanMultilangEnd = spanFixedAttrs.replace('begin', 'end') + '>{mlang}</span>';\n// Helper functions\nconst trim = v => v.toString().replace(/^\\s+/, '').replace(/\\s+$/, '');\nconst isNull = a => a === null || a === undefined;\n// Marker to remember when the blur event occurred.\nlet isBlurred = false;\n\n/**\n * Convert {mlang xx} and {mlang} strings to spans, so we can style them visually.\n * Remove superflous whitespace while at it.\n * @param {tinymce.Editor} ed\n * @param {string|null} content\n * @return {string}\n */\nconst addVisualStyling = function(ed, content) {\n    if (isNull(content)) {\n        content = ed.getContent();\n    }\n\n    // Do not use a variable whether text is already highlighted, do a check for the existing class\n    // because this is safe for many tiny element windows at one page.\n    if (content.indexOf(spanClass) !== -1) {\n        return content;\n    }\n\n    content = content.replace(new RegExp('{\\\\s*mlang\\\\s+([^}]+?)\\\\s*}', 'ig'), function(match, p1) {\n        return spanMultilangBegin.replace(new RegExp('%lang', 'g'), p1);\n    });\n    content = content.replace(new RegExp('{\\\\s*mlang\\\\s*}', 'ig'), spanMultilangEnd);\n\n    if (!isFallbackSpanTag(ed)) {\n        return content;\n    }\n    const dom = new DOMParser();\n    const doc = dom.parseFromString(content, 'text/html');\n    let nodes = doc.querySelectorAll('span.multilang');\n    for (const span of nodes) {\n        const newSpan = spanMultilangBegin\n            .replace(new RegExp('%lang', 'g'), span.getAttribute('lang'))\n            .replace('mceNonEditable', 'mceNonEditable fallback')\n          + span.innerHTML\n          + spanMultilangEnd\n            .replace('mceNonEditable', 'mceNonEditable fallback');\n        content = content.replace(span.outerHTML, newSpan);\n    }\n    return content;\n};\n\n/**\n * Remove the spans we added in _add_visual_styling() to leave only the {mlang xx} and {mlang} tags.\n * Also make sure we lowercase the multilang 'tags'\n * @param {tinymce.Editor} ed\n */\nconst removeVisualStyling = function(ed) {\n    ['begin', 'end'].forEach(function(t) {\n        for (const span of ed.dom.select('span.multilang-' + t)) {\n            if (t === 'begin' && span.classList.contains('fallback')) {\n                // This placeholder tag was created from an oldstyle <span class=\"multilang\"> tag.\n                let innerHTML = '';\n                let end = span;\n                let toRemove = [];\n                // Search the corresponding closing tag.\n                while (end) {\n                    end = end.nextSibling;\n                    if (isNull(end)) { // Got a parent that does not exist. Stop here.\n                        break;\n                    }\n                    if (!isNull(end.classList) && end.classList.contains('multilang-end')) {\n                        // We found the multilang-end node, that needs to be removed, and also, we can stop here.\n                        toRemove.push(end);\n                        break;\n                    }\n                    // Sibling inside the tags need to be preserved, but moved to the innerHTML of the real\n                    // span tag. Therefore, collect the node content as string and remember the real nodes\n                    // to remove them later.\n                    if (end.nodeType === 3) {\n                        innerHTML += end.nodeValue;\n                    } else if (end.nodeType === 1) {\n                        innerHTML += end.outerHTML;\n                    }\n                    toRemove.push(end);\n                }\n                if (!isNull(end)) {\n                    // Extract the language from the {mlang XX} tag.\n                    const lang = span.innerHTML.match(new RegExp('{\\\\s*mlang\\\\s+([^}]+?)\\\\s*}', 'i'));\n                    if (lang) {\n                        // Create the new <span class=\"multilang\"> tag with the content.\n                        ed.dom.setOuterHTML(\n                          span,\n                          '<span class=\"multilang\" lang=\"' + lang[1] + '\">' + innerHTML + '</span>'\n                        );\n                        // And remove the other siblings.\n                        for (end of toRemove) {\n                            ed.dom.remove(end);\n                        }\n                    }\n                }\n            } else {\n                // Normal placeholder tag, just restore the innerHTML that is {mlang XX} or {mlang}-\n                ed.dom.setOuterHTML(span, span.innerHTML.toLowerCase());\n            }\n        }\n    });\n};\n\n/**\n * At the current selection lookup for the current node. If we are inside a special span that encapsulates\n * the {lang} tag, then look for the corresponding opening or closing tag, depending on what's set in the\n * search param.\n * @param {tinymce.Editor} ed\n * @param {string} search\n * @return {Node|null} The encapsulating span tag if found.\n */\nconst getHighlightNodeFromSelect = function(ed, search) {\n    let span;\n    ed.dom.getParents(ed.selection.getStart(), elm => {\n        // Are we in a span that highlights the lang tag.\n        if (!isNull(elm.classList)) {\n            // If we are on an opening/closing lang tag, we need to search for the corresponding opening/closing tag.\n            const pair = search === 'begin' ? 'end' : 'begin';\n            if (elm.classList.contains('multilang-' + pair)) {\n                span = elm;\n                do {\n                    // If we look for begin, go back siblings, otherwise look fnext siblings until end is found.\n                    span = search === 'begin' ? span.previousSibling : span.nextSibling;\n                } while (!isNull(span) && (isNull(span.classList) || !span.classList.contains('multilang-' + search)));\n            } else if (elm.classList.contains('multilang-' + search)) {\n                // We are already on the correct tag we search for\n                span = elm;\n            }\n        }\n    });\n    return span;\n};\n\n/**\n * When loading the editor for the first time, add the spans for highlighting the content.\n * @param {tinymce.Editor} ed\n */\nconst onInit = function(ed) {\n    if (isContentToHighlight(ed)) {\n        ed.dom.addStyle(getHighlightCss(ed));\n        ed.setContent(addVisualStyling(ed));\n    }\n};\n\n/**\n * When the source code view dialogue is show, we must remove the highlight spans from the editor content\n * and also add them again when the dialogue is closed.\n * Since this event is also triggered when the editor data is saved, we use this function to remove the\n * highlighting content at that time.\n * @param {tinymce.Editor} ed\n * @param {object} content\n */\nconst onBeforeGetContent = function(ed, content) {\n    if (!isNull(content.source_view) && content.source_view === true) {\n        // If the user clicks on 'Cancel' or the close button on the html\n        // source code dialog view, make sure we re-add the visual styling.\n        var onClose = function(ed) {\n            ed.off('close', onClose);\n            ed.setContent(addVisualStyling(ed));\n        };\n        ed.on('CloseWindow', () => {\n            onClose(ed);\n        });\n\n        if (isContentToHighlight(ed)) {\n            removeVisualStyling(ed);\n        }\n    }\n};\n\n/**\n * Before saving and when the editor looses the focus, this event is triggered.\n * @param {tinymce.Editor} ed\n * @param {object} content\n * @param {string} event\n */\nconst onProcess = function(ed, content, event) {\n    if (!isNull(content.save) && content.save === true && isContentToHighlight(ed)) {\n        if (event === 'PostProcess') {\n            // When the blur event was triggered, the editor is still there, we need to reapply\n            // the previously removed styling. If this was a submit event, then do not reapply the\n            // styling to prevent that this is saved in the database.\n            if (isBlurred) {\n                ed.setContent(addVisualStyling(ed));\n                isBlurred = false;\n            }\n        } else {\n            removeVisualStyling(ed);\n        }\n    }\n};\n\n\n/**\n * Notice that when the editor content is blurred, because the focus left the editor window.\n */\nconst onBlur = function () {\n    isBlurred = true;\n};\n\n/**\n * Check for key press <del> when something is deleted. If that happens inside a highlight span\n * tag, then remove this tag and the corresponding that open/closes this lang tag.\n * @param {tinymce.Editor} ed\n * @param {Object} event\n */\nconst onDelete = function(ed, event) {\n    if (event.isComposing || (event.keyCode !== 46 && event.keyCode !== 8) || !isContentToHighlight(ed)) {\n        return;\n    }\n    // Key <del> was pressed, to delete some content. Check if we are inside a span for the lang.\n    const begin = getHighlightNodeFromSelect(ed, 'begin');\n    const end = getHighlightNodeFromSelect(ed, 'end');\n    // Only if both, start and end tag are found, then delete the nodes here and prevent the default handling\n    // because the stuff to be deleted is already gone.\n    if (!isNull(begin) && !isNull(end)) {\n        event.preventDefault();\n        ed.dom.remove(begin);\n        ed.dom.remove(end);\n    }\n};\n\n/**\n * The action when a language icon or menu entry is clicked. This adds the {mlang} tags at the current content\n * position or around the selection.\n * @param {tinymce.Editor} ed\n * @param {string} iso\n */\nconst applyLanguage = function(ed, iso) {\n    if (iso === null) {\n        return;\n    }\n    let text = ed.selection.getContent();\n    // Selection is empty, just insert the lang opening and closing tag\n    // together with a space where the user may add the content.\n    if (trim(text) === '') {\n        let newtext;\n        if (isContentToHighlight(ed)) {\n            newtext = spanMultilangBegin.replace(new RegExp('%lang', 'g'), iso) + ' ' + spanMultilangEnd;\n        } else {\n            newtext = '{mlang ' + iso + '}' + ' ' + '{mlang}';\n        }\n        ed.insertContent(newtext);\n        return;\n    }\n    // Selection contains something, we need to place the open and closing lang tags around the selection.\n    // However, there are a few exceptions, e.g. when the selection is inside the lang tag itself. In this case\n    // just change the tag without encapsulating the selection.\n    if (!isContentToHighlight(ed)) {\n        ed.selection.setContent('{mlang ' + iso + '}' + text + '{mlang}');\n        return;\n    }\n    // Syntax highlighting is on. Check if we are on a special span that encapsulates the language tags. Search\n    // for the start span tag.\n    const span = getHighlightNodeFromSelect(ed, 'begin');\n    // If we have a span, then it's the opening tag, and we just replace this one with the new iso.\n    if (!isNull(span)) {\n        let replacement = spanMultilangBegin.replace(new RegExp('%lang', 'g'), iso);\n        if (span.classList.contains('fallback')) {\n            replacement = replacement.replace('mceNonEditable', 'mceNonEditable fallback');\n        }\n        ed.dom.setOuterHTML(span, replacement);\n        return;\n    }\n    // Not inside a lang tag, insert a new opening and closing tag with the selection inside.\n    const newtext = spanMultilangBegin.replace(new RegExp('%lang', 'g'), iso) + text + spanMultilangEnd;\n    ed.selection.setContent(newtext);\n};\n\n\nexport {\n    onInit,\n    onBeforeGetContent,\n    onProcess,\n    onBlur,\n    onDelete,\n    applyLanguage\n};"],"names":["spanClass","spanFixedAttrs","spanMultilangBegin","spanMultilangEnd","replace","isNull","a","isBlurred","addVisualStyling","ed","content","getContent","indexOf","RegExp","match","p1","nodes","DOMParser","parseFromString","querySelectorAll","span","newSpan","getAttribute","innerHTML","outerHTML","removeVisualStyling","forEach","t","dom","select","classList","contains","end","toRemove","nextSibling","push","nodeType","nodeValue","lang","setOuterHTML","remove","toLowerCase","getHighlightNodeFromSelect","search","getParents","selection","getStart","elm","pair","previousSibling","addStyle","setContent","source_view","onClose","off","on","event","save","isComposing","keyCode","begin","preventDefault","iso","text","toString","newtext","insertContent","replacement"],"mappings":"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"}