{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["import {getHighlightCss, isContentToHighlight} from \"./options\";\n\n\nlet _already_highlighted = 0;\nconst _span_fixed_attrs = 'class=\"multilang-begin mceNonEditable\" data-mce-contenteditable=\"false\"';\nconst _span_multilang_begin = '<span ' + _span_fixed_attrs + ' lang=\"%lang\" xml:lang=\"%lang\">{mlang %lang}</span>';\nconst _span_multilang_end = '<span ' + _span_fixed_attrs.replace('begin', 'end') + '>{mlang}</span>';\n\nconst trim = v => v.toString().replace(/^\\s+/, '').replace(/\\s+$/, '');\n\n/**\n * Convert {mlang xx} and {mlang} strings to spans, so we can style them visually.\n * Remove superflous whitespace while at it.\n * @param {tinymce} ed\n * @param {string} content\n */\nconst _add_visual_styling = function(ed, content) {\n    if (_already_highlighted){\n        return content;\n    }\n\n    if (!content) {\n        content = ed.getContent();\n    }\n\n    // Work around for Chrome behaviour: apparently we can't do the .replace() on the\n    // _span_multilang_begin property, so we use a temporary variable instead.\n    let begin_str = _span_multilang_begin;\n    content = content.replace(new RegExp('{\\\\s*mlang\\\\s+([^}]+?)\\\\s*}', 'ig'), function(match, p1) {\n        return begin_str.replace(new RegExp('%lang', 'g'), p1);\n    });\n    content = content.replace(new RegExp('{\\\\s*mlang\\\\s*}', 'ig'), _span_multilang_end);\n\n    _already_highlighted = 1;\n    return content;\n};\n\n/**\n * Remove the spans we added in _add_visual_styling() to leave only the {mlang xx} and {mlang} tags.\n * Also make sure we lowercase the multilang 'tags'\n * @param {tinymce} ed\n */\nconst _remove_visual_styling = function(ed) {\n    if (!_already_highlighted) {\n      return;\n    }\n    ['begin', 'end'].forEach(function (t) {\n      let nodes = ed.dom.select('span.multilang-' + t);\n      for (let n = 0, l = nodes.length; n < l; n++) {\n        const span = nodes[n];\n        ed.dom.setOuterHTML(span, span.innerHTML.toLowerCase());\n      }\n    });\n    _already_highlighted = 0;\n};\n\nconst onInit = function(ed) {\n    if (isContentToHighlight(ed)) {\n        ed.dom.addStyle(getHighlightCss(ed));\n        ed.setContent(_add_visual_styling(ed, ed.getContent()));\n    }\n};\n\nconst onBeforeGetContent = function(ed, o) {\n  if (typeof o.source_view !== 'undefined' && o.source_view) {\n    // If the user clicks on 'Cancel' or the close button on the html\n    // source code dialog view, make sure we re-add the visual styling.\n    var onClose = function(window) {\n      var ed = window.editor;\n      ed.windowManager.onClose.remove(onClose);\n      ed.setContent(_add_visual_styling(ed, ed.getContent()));\n    };\n    ed.windowManager.onClose.add(onClose);\n\n    if (isContentToHighlight(ed)) {\n        _remove_visual_styling(ed);\n    }\n  }\n};\n\nconst onBeforeSetContent = function(ed, o) {\n  if (typeof o.source_view !== 'undefined' && o.source_view) {\n    if (isContentToHighlight(ed)) {\n      o.content = _add_visual_styling(ed, o.content);\n    }\n  }\n};\n\n// Add an observer to the onPreProcess event to remove the highlighting spans while saving the content.\nconst onPreProcess = function(ed, o) {\n  if (typeof o.save !== 'undefined' && o.save) {\n    if (isContentToHighlight(ed)) {\n      _remove_visual_styling(ed);\n      // Even if we have called _remove_visual_styling(), we are actually working\n      // on a copy of the content here. The original content of the editor is still\n      // highlighted, so keep the right state for _already_highlighted.\n      _already_highlighted = 1;\n    }\n  }\n};\n\nconst applyLanguage = function(ed, iso) {\n  if (iso === null) {\n    return;\n  }\n  let text = ed.selection.getContent();\n  let newtext;\n  if (trim(text) !== '') {\n      if (isContentToHighlight(ed)) {\n        newtext = _span_multilang_begin.replace(new RegExp('%lang', 'g'), iso) + text + _span_multilang_end;\n      } else {\n        newtext = '{mlang ' + iso +'}' + text + '{mlang}';\n      }\n      ed.selection.setContent(newtext);\n  } else {\n    if (isContentToHighlight(ed)) {\n      newtext = _span_multilang_begin.replace(new RegExp('%lang', 'g'), iso) + ' ' + _span_multilang_end;\n    } else {\n      newtext = '{mlang ' + iso +'}' + ' ' + '{mlang}';\n    }\n    ed.insertContent(newtext);\n  }\n};\n\n\nexport {\n    onInit,\n    onBeforeGetContent,\n    onBeforeSetContent,\n    onPreProcess,\n    applyLanguage\n};"],"names":["_already_highlighted","_span_fixed_attrs","_span_multilang_begin","_span_multilang_end","replace","_add_visual_styling","ed","content","getContent","begin_str","RegExp","match","p1","_remove_visual_styling","forEach","t","nodes","dom","select","n","l","length","span","setOuterHTML","innerHTML","toLowerCase","addStyle","setContent","o","source_view","onClose","window","editor","windowManager","remove","add","save","iso","newtext","text","selection","toString","insertContent"],"mappings":"yQAGIA,qBAAuB,QACrBC,kBAAoB,0EACpBC,sBAAwB,SAAWD,kBAAoB,sDACvDE,oBAAsB,SAAWF,kBAAkBG,QAAQ,QAAS,OAAS,kBAU7EC,oBAAsB,SAASC,GAAIC,YACjCP,4BACOO,QAGNA,UACDA,QAAUD,GAAGE,kBAKbC,UAAYP,6BAIhBK,SAHAA,QAAUA,QAAQH,QAAQ,IAAIM,OAAO,8BAA+B,OAAO,SAASC,MAAOC,WAChFH,UAAUL,QAAQ,IAAIM,OAAO,QAAS,KAAME,QAErCR,QAAQ,IAAIM,OAAO,kBAAmB,MAAOP,qBAE/DH,qBAAuB,EAChBO,SAQLM,uBAAyB,SAASP,IAC/BN,wBAGJ,QAAS,OAAOc,SAAQ,SAAUC,OAC7BC,MAAQV,GAAGW,IAAIC,OAAO,kBAAoBH,OACzC,IAAII,EAAI,EAAGC,EAAIJ,MAAMK,OAAQF,EAAIC,EAAGD,IAAK,OACtCG,KAAON,MAAMG,GACnBb,GAAGW,IAAIM,aAAaD,KAAMA,KAAKE,UAAUC,mBAG7CzB,qBAAuB,oBAGZ,SAASM,KAChB,iCAAqBA,MACrBA,GAAGW,IAAIS,UAAS,4BAAgBpB,KAChCA,GAAGqB,WAAWtB,oBAAoBC,GAAIA,GAAGE,6CAItB,SAASF,GAAIsB,WACT,IAAlBA,EAAEC,aAA+BD,EAAEC,YAAa,KAGrDC,QAAU,SAASC,YACjBzB,GAAKyB,OAAOC,OAChB1B,GAAG2B,cAAcH,QAAQI,OAAOJ,SAChCxB,GAAGqB,WAAWtB,oBAAoBC,GAAIA,GAAGE,gBAE3CF,GAAG2B,cAAcH,QAAQK,IAAIL,UAEzB,iCAAqBxB,KACrBO,uBAAuBP,kCAKJ,SAASA,GAAIsB,QACT,IAAlBA,EAAEC,aAA+BD,EAAEC,cACxC,iCAAqBvB,MACvBsB,EAAErB,QAAUF,oBAAoBC,GAAIsB,EAAErB,iCAMvB,SAASD,GAAIsB,QACV,IAAXA,EAAEQ,MAAwBR,EAAEQ,OACjC,iCAAqB9B,MACvBO,uBAAuBP,IAIvBN,qBAAuB,2BAKP,SAASM,GAAI+B,QACrB,OAARA,eAIAC,QADAC,KAAOjC,GAAGkC,UAAUhC,aAEL,KAAV+B,KAnGSE,WAAWrC,QAAQ,OAAQ,IAAIA,QAAQ,OAAQ,KAqG3DkC,SADE,iCAAqBhC,IACbJ,sBAAsBE,QAAQ,IAAIM,OAAO,QAAS,KAAM2B,KAAOE,KAAOpC,oBAEtE,UAAYkC,IAAK,IAAME,KAAO,UAE1CjC,GAAGkC,UAAUb,WAAWW,WAGxBA,SADE,iCAAqBhC,IACbJ,sBAAsBE,QAAQ,IAAIM,OAAO,QAAS,KAAM2B,KAAO,IAAMlC,oBAErE,UAAYkC,IAAZ,YAEZ/B,GAAGoC,cAAcJ"}